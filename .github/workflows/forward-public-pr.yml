name: Forward Public PR to Private Repo

on:
  pull_request:
    types: [opened]

env:
  PRIVATE_REPO_OWNER: "Laotian21"
  PRIVATE_REPO_NAME: "pz-mod-translation-helper"
  # å¤šä¸ªå®¡æŸ¥è€…ç”¨é€—å·åˆ†éš”ï¼Œä¸è¦æœ‰ç©ºæ ¼ã€‚
  DEFAULT_REVIEWERS: "Laotian21"
  PRIVATE_REPO_BASE: "main"

jobs:
  forward_pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout Public Repository's Base Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Fetch Public PR Head
        run: |
          set -e
          git remote add pr_head ${{ github.event.pull_request.head.repo.clone_url }}
          git fetch pr_head ${{ github.event.pull_request.head.ref }}

      - name: Get Public PR Details and Prepare for Private Repo
        id: pr_details
        run: |
          set -e
          PUBLIC_PR_NUMBER="${{ github.event.pull_request.number }}"
          PUBLIC_PR_TITLE="${{ github.event.pull_request.title }}"
          PUBLIC_PR_BODY="${{ github.event.pull_request.body }}"
          PUBLIC_REPO_FULL_NAME="${{ github.repository }}"
          PUBLIC_PR_URL="${{ github.event.pull_request.html_url }}"
          PUBLIC_PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          NEW_PRIVATE_BRANCH="public-pr-${PUBLIC_PR_NUMBER}"

          MODIFIED_FOLDERS=$(git diff --name-only "origin/${{ github.event.pull_request.base.ref }}" "pr_head/${{ github.event.pull_request.head.ref }}" | \
                             grep '^completed_files/' | cut -d'/' -f2 | sort -u)

          if [ -n "$MODIFIED_FOLDERS" ]; then
            CHANGES_SUMMARY="### ğŸ’¡ å½±å“çš„æ¨¡ç»„ ID\n\n"
            while IFS= read -r folder; do
              CHANGES_SUMMARY="${CHANGES_SUMMARY}- \`${folder}\`\n"
            done <<< "$MODIFIED_FOLDERS"
          else
            CHANGES_SUMMARY="### ğŸ’¡ å½±å“çš„æ¨¡ç»„ ID\n\n- _æœªæ£€æµ‹åˆ° completed_files ç›®å½•ä¸‹çš„å˜æ›´ã€‚_"
          fi

          {
            echo "PRIVATE_PR_BODY<<EOF"
            echo "âœ¨ *æ¥è‡ªå…¬å¼€ä»“åº“çš„è´¡çŒ®* âœ¨"
            echo "---"
            echo "åŸå§‹ PR: [${PUBLIC_REPO_FULL_NAME}#${PUBLIC_PR_NUMBER}](${PUBLIC_PR_URL})"
            if [ -n "$PUBLIC_PR_AUTHOR" ]; then echo "è´¡çŒ®è€…: @${PUBLIC_PR_AUTHOR}"; fi
            echo ""
            echo -e "${CHANGES_SUMMARY}"
            echo ""
            echo "--- åŸå§‹æè¿° ---"
            echo "${PUBLIC_PR_BODY}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "PUBLIC_PR_NUMBER=${PUBLIC_PR_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "PUBLIC_PR_TITLE=${PUBLIC_PR_TITLE}" >> "$GITHUB_OUTPUT"
          echo "NEW_PRIVATE_BRANCH=${NEW_PRIVATE_BRANCH}" >> "$GITHUB_OUTPUT"

      - name: Generate Patches from Public PR
        id: generate_patches
        run: |
          set -e
          mkdir -p ../patches
          git format-patch "origin/${{ github.event.pull_request.base.ref }}..pr_head/${{ github.event.pull_request.head.ref }}" -o ../patches
          if [ -z "$(ls -A ../patches)" ]; then
            echo "patches_generated=false" >> "$GITHUB_OUTPUT"
          else
            echo "patches_generated=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Git and Clone Private Repo
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          set -e
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git clone "https://x-access-token:${PRIVATE_REPO_TOKEN}@github.com/${{ env.PRIVATE_REPO_OWNER }}/${{ env.PRIVATE_REPO_NAME }}.git" private_clone
          cd private_clone
          git checkout -b "${{ steps.pr_details.outputs.NEW_PRIVATE_BRANCH }}"

      - name: Apply Patches to Private Repo
        id: apply_patches
        if: steps.generate_patches.outputs.patches_generated == 'true'
        working-directory: ./private_clone
        run: |
          set -e
          if ! git am -3 --keep-non-patch --ignore-space-change ../patches/*.patch; then
            echo "::error::æ— æ³•è‡ªåŠ¨åº”ç”¨è¡¥ä¸ï¼Œå­˜åœ¨å†²çªã€‚"
            git am --abort
            git apply --reject ../patches/*.patch || true
            git add .

            git commit -m "[CONFLICT] è‡ªåŠ¨è½¬å‘ PR #${{ steps.pr_details.outputs.PUBLIC_PR_NUMBER }}ï¼ˆåŒ…å« .rej æ–‡ä»¶ï¼Œéœ€äººå·¥å¤„ç†ï¼‰"
            git push origin "${{ steps.pr_details.outputs.NEW_PRIVATE_BRANCH }}"
            echo "patches_applied=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          git push origin "${{ steps.pr_details.outputs.NEW_PRIVATE_BRANCH }}"
          echo "patches_applied=true" >> "$GITHUB_OUTPUT"

      - name: Handle Failures and Create Conflict PR
        if: success() && (steps.generate_patches.outputs.patches_generated == 'false' || steps.apply_patches.outputs.patches_applied == 'false')
        env:
          # ç”¨äºåœ¨å…¬å¼€ PR ä¸Šè¯„è®º
          GH_TOKEN: ${{ github.token }}
          PRIVATE_GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          set -e
          PUBLIC_PR_NUMBER="${{ steps.pr_details.outputs.PUBLIC_PR_NUMBER }}"
          if [ "${{ steps.generate_patches.outputs.patches_generated }}" == "false" ]; then
            MESSAGE="ğŸ“¢ **è‡ªåŠ¨åŒ–é€šçŸ¥**: æ‚¨çš„ PR ä¸­æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„æ–‡ä»¶æ›´æ”¹ã€‚"
            gh pr comment "$PUBLIC_PR_NUMBER" --repo "${{ github.repository }}" --body "$MESSAGE"
          elif [ "${{ steps.apply_patches.outputs.patches_applied }}" == "false" ]; then
            MESSAGE="âš ï¸ **è‡ªåŠ¨åŒ–é€šçŸ¥**: æ‚¨çš„ PR åœ¨è½¬å‘æ—¶é‡åˆ°åˆå¹¶å†²çªã€‚æˆ‘ä»¬å·²åœ¨ç§æœ‰ä»“åº“ä¸­åˆ›å»ºäº†ä¸€ä¸ªå¾…å¤„ç†çš„ PRï¼Œç»´æŠ¤è€…å°†è¿›è¡Œäººå·¥å®¡æŸ¥ã€‚"
            gh pr comment "$PUBLIC_PR_NUMBER" --repo "${{ github.repository }}" --body "$MESSAGE"
            
            CONFLICT_PR_BODY=$(cat <<EOF
            âš ï¸ **è‡ªåŠ¨åˆå¹¶å¤±è´¥** âš ï¸

            æ­¤ PR æ˜¯ä»å…¬å¼€ä»“åº“çš„ [PR #${PUBLIC_PR_NUMBER}](${{ github.event.pull_request.html_url }}) è‡ªåŠ¨è½¬å‘è€Œæ¥ï¼Œä½†åœ¨åº”ç”¨è¡¥ä¸æ—¶é‡åˆ°äº†åˆå¹¶å†²çªã€‚

            **éœ€è¦äººå·¥æ“ä½œï¼š**
            1.  è¯·åœ¨æ­¤åˆ†æ”¯ä¸­æ‰‹åŠ¨è§£å†³å†²çªï¼ˆæ³¨æ„æ£€æŸ¥ \`.rej\` æ–‡ä»¶ï¼‰ã€‚
            2.  è§£å†³åï¼Œæ­£å¸¸å®¡æŸ¥å¹¶åˆå¹¶æ­¤ PRã€‚
            EOF
            )

            GH_TOKEN=${PRIVATE_GH_TOKEN} gh pr create \
              --repo "${{ env.PRIVATE_REPO_OWNER }}/${{ env.PRIVATE_REPO_NAME }}" \
              --head "${{ steps.pr_details.outputs.NEW_PRIVATE_BRANCH }}" \
              --base "${{ env.PRIVATE_REPO_BASE }}" \
              --title "[CONFLICT] Forward Public PR #${PUBLIC_PR_NUMBER}: ${{ steps.pr_details.outputs.PUBLIC_PR_TITLE }}" \
              --body "$CONFLICT_PR_BODY" \
              --reviewer "${{ env.DEFAULT_REVIEWERS }}" \
              --label "public-contribution" \
              --label "conflict"
          fi

      - name: Create Pull Request in Private Repo
        if: success() && steps.generate_patches.outputs.patches_generated == 'true' && steps.apply_patches.outputs.patches_applied == 'true'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          set -e
          gh pr create \
            --repo "${{ env.PRIVATE_REPO_OWNER }}/${{ env.PRIVATE_REPO_NAME }}" \
            --head "${{ steps.pr_details.outputs.NEW_PRIVATE_BRANCH }}" \
            --base "${{ env.PRIVATE_REPO_BASE }}" \
            --title "Forward Public PR #${{ steps.pr_details.outputs.PUBLIC_PR_NUMBER }}: ${{ steps.pr_details.outputs.PUBLIC_PR_TITLE }}" \
            --body "$(cat <<'EOF'
          ${{ steps.pr_details.outputs.PRIVATE_PR_BODY }}
          EOF
          )" \
            --reviewer "${{ env.DEFAULT_REVIEWERS }}" \
            --label "public-contribution"