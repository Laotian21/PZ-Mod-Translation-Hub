name: Forward Public PR to Private Repo

on:
  pull_request:
    types: [opened]
  workflow_dispatch:
    inputs:
      pull_request_number:
        description: 'è¦é‡æ–°è½¬å‘çš„å…¬å¼€ PR å·ç  (å¯é€‰)'
        required: false
        type: number
      force_rerun:
        description: 'å³ä½¿æœªæ£€æµ‹åˆ°æ›´æ”¹ä¹Ÿå¼ºåˆ¶é‡æ–°è¿è¡Œ'
        required: false
        type: boolean
        default: false

env:
  PRIVATE_REPO_OWNER: "Laotian21"
  PRIVATE_REPO_NAME: "pz-mod-translation-helper"
  # å¤šä¸ªå®¡æŸ¥è€…ç”¨é€—å·åˆ†éš”ï¼Œä¸è¦æœ‰ç©ºæ ¼ã€‚
  DEFAULT_REVIEWERS: "Laotian21"
  PRIVATE_REPO_BASE: "main"

jobs:
  forward_pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Determine PR Info and set outputs
        id: pr_info
        run: |
          # Ensure jq is installed for parsing JSON
          sudo apt-get update && sudo apt-get install -y jq

          PR_NUMBER_INPUT="${{ github.event.inputs.pull_request_number }}"
          PUBLIC_REPO_FULL_NAME="${{ github.repository }}"

          if [ -n "$PR_NUMBER_INPUT" ]; then
            # workflow_dispatch (æ‰‹åŠ¨è§¦å‘)
            PR_NUMBER="$PR_NUMBER_INPUT"
            echo "Workflow triggered manually for PR #$PR_NUMBER."

            # ä½¿ç”¨ gh CLI è·å– PR è¯¦ç»†ä¿¡æ¯
            PR_JSON=$(gh pr view "$PR_NUMBER" --json number,title,body,url,author,baseRefName,headRefName,headRefOid,headRepositoryOwner,headRepository --repo "$PUBLIC_REPO_FULL_NAME")
            
            echo "PUBLIC_PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_TITLE=$(echo "$PR_JSON" | jq -r .title)" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_BODY<<EOF_BODY_MANUAL" >> "$GITHUB_OUTPUT"
            printf "%s\n" "$(echo "$PR_JSON" | jq -r .body)" >> "$GITHUB_OUTPUT"
            echo "EOF_BODY_MANUAL" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_URL=$(echo "$PR_JSON" | jq -r .url)" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_AUTHOR=$(echo "$PR_JSON" | jq -r .author.login)" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_BASE_REF=$(echo "$PR_JSON" | jq -r .baseRefName)" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_HEAD_REF=$(echo "$PR_JSON" | jq -r .headRefName)" >> "$GITHUB_OUTPUT"
            
            HEAD_REPO_URL=$(echo "$PR_JSON" | jq -r '.headRepository.url')
            if [ "$HEAD_REPO_URL" != "null" ]; then
              echo "PUBLIC_PR_HEAD_REPO_URL=$HEAD_REPO_URL" >> "$GITHUB_OUTPUT"
            else
              HEAD_REPO_OWNER_LOGIN=$(echo "$PR_JSON" | jq -r '.headRepositoryOwner.login')
              HEAD_REPO_NAME=$(echo "$PR_JSON" | jq -r '.headRepository.name')
              echo "PUBLIC_PR_HEAD_REPO_URL=https://github.com/${HEAD_REPO_OWNER_LOGIN}/${HEAD_REPO_NAME}" >> "$GITHUB_OUTPUT"
            fi

            echo "PUBLIC_PR_HEAD_SHA=$(echo "$PR_JSON" | jq -r .headRefOid)" >> "$GITHUB_OUTPUT"
            echo "TRIGGER_TYPE=manual" >> "$GITHUB_OUTPUT"
          else
            # pull_request (PR æ‰“å¼€æ—¶è‡ªåŠ¨è§¦å‘)
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "Workflow triggered by pull_request event for PR #$PR_NUMBER."
            
            echo "PUBLIC_PR_NUMBER=$PR_NUMBER" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_TITLE=${{ github.event.pull_request.title }}" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_BODY<<EOF_BODY_AUTO" >> "$GITHUB_OUTPUT"
            printf "%s\n" "${{ github.event.pull_request.body }}" >> "$GITHUB_OUTPUT"
            echo "EOF_BODY_AUTO" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_URL=${{ github.event.pull_request.html_url }}" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_BASE_REF=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_HEAD_REF=${{ github.event.pull_request.head.ref }}" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_HEAD_REPO_URL=${{ github.event.pull_request.head.repo.clone_url }}" >> "$GITHUB_OUTPUT"
            echo "PUBLIC_PR_HEAD_SHA=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            echo "TRIGGER_TYPE=pull_request" >> "$GITHUB_OUTPUT"
          fi
          echo "NEW_PRIVATE_BRANCH=public-pr-${PR_NUMBER}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Checkout Public Repository's Base Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr_info.outputs.PUBLIC_PR_BASE_REF }}
          fetch-depth: 0

      - name: Fetch Public PR Head
        run: |
          set -e
          git remote add pr_head ${{ steps.pr_info.outputs.PUBLIC_PR_HEAD_REPO_URL }}
          git fetch pr_head ${{ steps.pr_info.outputs.PUBLIC_PR_HEAD_REF }}

      - name: Generate Patches from Public PR
        id: generate_patches
        run: |
          set -e
          mkdir -p patches
          
          COMMIT_RANGE="origin/${{ steps.pr_info.outputs.PUBLIC_PR_BASE_REF }}..pr_head/${{ steps.pr_info.outputs.PUBLIC_PR_HEAD_REF }}"

          BASE_REF_SHA=$(git rev-parse "origin/${{ steps.pr_info.outputs.PUBLIC_PR_BASE_REF }}")
          HEAD_REF_SHA=$(git rev-parse "pr_head/${{ steps.pr_info.outputs.PUBLIC_PR_HEAD_REF }}")
          
          if [ "$BASE_REF_SHA" = "$HEAD_REF_SHA" ]; then
              echo "Warning: Base and Head references point to the same commit. No changes detected."
              echo "patches_generated=false" >> "$GITHUB_OUTPUT"
              exit 0
          fi

          MODIFIED_FILES=$(git diff --name-only "$COMMIT_RANGE")
          FILES_TO_PATCH=$(echo "$MODIFIED_FILES" | grep '^data/')

          if [ -n "$FILES_TO_PATCH" ]; then
            echo "Generating patches for the following files:"
            echo "$FILES_TO_PATCH"
            
            mapfile -t FILE_ARRAY <<< "$FILES_TO_PATCH"
  
            if [ ${#FILE_ARRAY[@]} -eq 0 ]; then
                echo "Warning: Files were detected under 'data/', but could not be parsed into array."
                echo "patches_generated=false" >> "$GITHUB_OUTPUT"
            else
                git format-patch "$COMMIT_RANGE" -o patches -- "${FILE_ARRAY[@]}" || true
                
                if find patches -maxdepth 1 -name "*.patch" -print -quit | grep -q .; then
                    echo "Patch files successfully generated."
                    echo "patches_generated=true" >> "$GITHUB_OUTPUT"
                else
                    echo "Warning: git format-patch command executed, but no patch files were found."
                    echo "patches_generated=false" >> "$GITHUB_OUTPUT"
                fi
            fi
          else
            echo "No relevant files under 'data/' were modified. Skipping patch generation."
            echo "patches_generated=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Debug Secret Value (DO NOT LOG VALUE DIRECTLY)
        run: |
          if [ -z "$PRIVATE_REPO_TOKEN" ]; then
            echo "::error::PRIVATE_REPO_TOKEN appears to be empty or unset. Please re-check the secret in repository settings."
            exit 1
          else
            echo "PRIVATE_REPO_TOKEN is set (not empty)."
          fi
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: Setup Git and Clone Private Repo
        env:
          PRIVATE_REPO_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          set -e
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git clone "https://x-access-token:${PRIVATE_REPO_TOKEN}@github.com/${{ env.PRIVATE_REPO_OWNER }}/${{ env.PRIVATE_REPO_NAME }}.git" private_clone
          cd private_clone
          git checkout -b "${{ steps.pr_info.outputs.NEW_PRIVATE_BRANCH }}"

      - name: Apply Patches to Private Repo
        id: apply_patches
        if: ${{ steps.generate_patches.outputs.patches_generated == 'true' || github.event.inputs.force_rerun == true }}
        working-directory: ./private_clone
        run: |
          set -e
          if [ "${{ steps.generate_patches.outputs.patches_generated }}" == "true" ]; then
              if ! git am -3 --keep-non-patch --ignore-space-change ../patches/*.patch; then
                echo "::error::æ— æ³•è‡ªåŠ¨åº”ç”¨è¡¥ä¸ï¼Œå­˜åœ¨å†²çªã€‚"
                git am --abort
                
                git apply --reject ../patches/*.patch || true
                git add .

                git commit -m "[CONFLICT] è‡ªåŠ¨è½¬å‘ PR #${{ steps.pr_info.outputs.PUBLIC_PR_NUMBER }}ï¼ˆåŒ…å« .rej æ–‡ä»¶ï¼Œéœ€äººå·¥å¤„ç†ï¼‰"
                git push origin "${{ steps.pr_info.outputs.NEW_PRIVATE_BRANCH }}"
                echo "patches_applied=false" >> "$GITHUB_OUTPUT"
                exit 0
              fi
              
              git push origin "${{ steps.pr_info.outputs.NEW_PRIVATE_BRANCH }}"
              echo "patches_applied=true" >> "$GITHUB_OUTPUT"
          else
              echo "æ²¡æœ‰ç”Ÿæˆè¡¥ä¸æ–‡ä»¶ï¼Œè·³è¿‡è¡¥ä¸åº”ç”¨æ­¥éª¤ã€‚"
              echo "patches_applied=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Handle Failures and Create Conflict PR
        if: success() && ((steps.generate_patches.outputs.patches_generated == 'false' && github.event.inputs.force_rerun != true) || steps.apply_patches.outputs.patches_applied == 'false')
        env:
          GH_TOKEN: ${{ github.token }}
          PRIVATE_GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
        run: |
          set -e
          PUBLIC_PR_NUMBER="${{ steps.pr_info.outputs.PUBLIC_PR_NUMBER }}"
          PUBLIC_PR_TITLE="${{ steps.pr_info.outputs.PUBLIC_PR_TITLE }}"
          PUBLIC_PR_URL="${{ steps.pr_info.outputs.PUBLIC_PR_URL }}"
          NEW_PRIVATE_BRANCH="${{ steps.pr_info.outputs.NEW_PRIVATE_BRANCH }}"

          if [ "${{ steps.generate_patches.outputs.patches_generated }}" == "false" ] && [ "${{ github.event.inputs.force_rerun }}" != "true" ]; then
            MESSAGE="ğŸ“¢ **è‡ªåŠ¨åŒ–é€šçŸ¥**: æ‚¨çš„ PR ä¸­æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„æ–‡ä»¶æ›´æ”¹ã€‚"
            gh pr comment "$PUBLIC_PR_NUMBER" --repo "${{ github.repository }}" --body "$MESSAGE"
          elif [ "${{ steps.apply_patches.outputs.patches_applied }}" == "false" ]; then
            MESSAGE="âš ï¸ **è‡ªåŠ¨åŒ–é€šçŸ¥**: æ‚¨çš„ PR åœ¨è½¬å‘æ—¶é‡åˆ°åˆå¹¶å†²çªã€‚æˆ‘ä»¬å·²åœ¨ç§æœ‰ä»“åº“ä¸­åˆ›å»ºäº†ä¸€ä¸ªå¾…å¤„ç†çš„ PRï¼Œç»´æŠ¤è€…å°†è¿›è¡Œäººå·¥å®¡æŸ¥ã€‚"
            gh pr comment "$PUBLIC_PR_NUMBER" --repo "${{ github.repository }}" --body "$MESSAGE"
            
            CONFLICT_PR_BODY=$(cat <<EOF
            âš ï¸ **è‡ªåŠ¨åˆå¹¶å¤±è´¥** âš ï¸

            æ­¤ PR æ˜¯ä»å…¬å¼€ä»“åº“çš„ [PR #${PUBLIC_PR_NUMBER}](${PUBLIC_PR_URL}) è‡ªåŠ¨è½¬å‘è€Œæ¥ï¼Œä½†åœ¨åº”ç”¨è¡¥ä¸æ—¶é‡åˆ°äº†åˆå¹¶å†²çªã€‚

            **éœ€è¦äººå·¥æ“ä½œï¼š**
            1.  è¯·åœ¨æ­¤åˆ†æ”¯ä¸­æ‰‹åŠ¨è§£å†³å†²çªï¼ˆæ³¨æ„æ£€æŸ¥ \`.rej\` æ–‡ä»¶ï¼‰ã€‚
            2.  è§£å†³åï¼Œæ­£å¸¸å®¡æŸ¥å¹¶åˆå¹¶æ­¤ PRã€‚
            EOF
            )

            GH_TOKEN=${PRIVATE_GH_TOKEN} gh pr create \
              --repo "${{ env.PRIVATE_REPO_OWNER }}/${{ env.PRIVATE_REPO_NAME }}" \
              --head "${NEW_PRIVATE_BRANCH}" \
              --base "${{ env.PRIVATE_REPO_BASE }}" \
              --title "[CONFLICT] Forward Public PR #${PUBLIC_PR_NUMBER}: ${PUBLIC_PR_TITLE}" \
              --body "$CONFLICT_PR_BODY" \
              --reviewer "${{ env.DEFAULT_REVIEWERS }}" \
              --label "public-contribution" \
              --label "conflict"
          fi

      - name: Create Pull Request in Private Repo
        if: success() && steps.generate_patches.outputs.patches_generated == 'true' && steps.apply_patches.outputs.patches_applied == 'true'
        env:
          GH_TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          PUBLIC_PR_BODY: ${{ steps.pr_info.outputs.PUBLIC_PR_BODY }}
        run: |
          set -e

          PRIVATE_PR_BODY=$(cat <<EOF
          âœ¨ **æ¥è‡ªå…¬å¼€ä»“åº“çš„è´¡çŒ®** âœ¨

          **åŸå§‹ PR**: [${{ github.repository }}#${{ steps.pr_info.outputs.PUBLIC_PR_NUMBER }}](${{ steps.pr_info.outputs.PUBLIC_PR_URL }})
          **è´¡çŒ®è€…**: @${{ steps.pr_info.outputs.PUBLIC_PR_AUTHOR }}

          --- åŸå§‹æè¿° ---
          $PUBLIC_PR_BODY
          EOF
          )

          gh pr create \
            --repo "${{ env.PRIVATE_REPO_OWNER }}/${{ env.PRIVATE_REPO_NAME }}" \
            --head "${{ steps.pr_info.outputs.NEW_PRIVATE_BRANCH }}" \
            --base "${{ env.PRIVATE_REPO_BASE }}" \
            --title "Forward Public PR #${{ steps.pr_info.outputs.PUBLIC_PR_NUMBER }}: ${{ steps.pr_info.outputs.PUBLIC_PR_TITLE }}" \
            --body "$PRIVATE_PR_BODY" \
            --reviewer "${{ env.DEFAULT_REVIEWERS }}" \
            --label "public-contribution"